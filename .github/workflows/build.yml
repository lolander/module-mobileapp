name: iOS Build and Export

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install npm dependencies
      run: npm install
      working-directory: app/MobileTerminal

    - name: Install CocoaPods
      run: | 
        gem install cocoapods
        pod install
      working-directory: app/MobileTerminal/ios

    - name: Archive and Export iOS App
      run: |
        RN_PROJECT_DIR="$GITHUB_WORKSPACE/app/MobileTerminal"
        IOS_PROJECT_DIR="$RN_PROJECT_DIR/ios"
        BUILD_OUTPUT_DIR="$GITHUB_WORKSPACE/builds"
        APP_NAME="MobileTerminal"
        EXPORT_OPTIONS_PLIST="$GITHUB_WORKSPACE/ExportOptions.plist"

        mkdir -p "$BUILD_OUTPUT_DIR"
        cd "$IOS_PROJECT_DIR"

        # Clean the build folder
        xcodebuild clean -workspace "$APP_NAME.xcworkspace" -scheme "$APP_NAME" || exit 1

        # Archive the app
        ARCHIVE_PATH="$BUILD_OUTPUT_DIR/$APP_NAME.xcarchive"
        xcodebuild archive -workspace "$APP_NAME.xcworkspace" -scheme "$APP_NAME" -archivePath "$ARCHIVE_PATH" || exit 1

        # Export the archive to an .ipa file
        EXPORT_PATH="$BUILD_OUTPUT_DIR"
        xcodebuild -exportArchive -archivePath "$ARCHIVE_PATH" -exportPath "$EXPORT_PATH" -exportOptionsPlist "$EXPORT_OPTIONS_PLIST" || exit 1

        echo "iOS app built and exported to $EXPORT_PATH/$APP_NAME.ipa"

    - name: Upload IPA as artifact
      uses: actions/upload-artifact@v4
      with:
        name: MobileTerminal-IPA
        path: ${{ github.workspace }}/builds/MobileTerminal.ipa
