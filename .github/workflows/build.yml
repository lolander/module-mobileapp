name: iOS Build and Export

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    env:
      RN_PROJECT_DIR: ${{ github.workspace }}/app/MobileTerminal
      IOS_PATH: ${{ github.workspace }}/app/MobileTerminal/ios
      EXPORT_OPTIONS_PLIST: ${{ github.workspace }}/app/MobileTerminal/ExportOptions.plist

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install npm dependencies
      run: npm install
      working-directory: app/MobileTerminal

        - name: Install CocoaPods
          run: |
            set -e
            gem install cocoapods
            pod install
            ls -F
          working-directory: app/MobileTerminal/ios
    - name: Print ExportOptions.plist content
      run: cat "$EXPORT_OPTIONS_PLIST"

    - name: Archive and Export iOS App
      env:
        RN_PROJECT_DIR: ${{ github.workspace }}/app/MobileTerminal
        IOS_PATH: ${{ github.workspace }}/app/MobileTerminal/ios
        EXPORT_OPTIONS_PLIST: ${{ github.workspace }}/app/MobileTerminal/ExportOptions.plist
      run: |
        BUILD_OUTPUT_DIR="$GITHUB_WORKSPACE/builds"
        APP_NAME="MobileTerminal"

        mkdir -p "$BUILD_OUTPUT_DIR"
        cd "$IOS_PROJECT_DIR"

        # Clean the build folder
        xcodebuild clean -workspace "$APP_NAME.xcworkspace" -scheme "$APP_NAME" || exit 1

        # Archive the app
        ARCHIVE_PATH="$BUILD_OUTPUT_DIR/$APP_NAME.xcarchive"
        xcodebuild archive -workspace "$APP_NAME.xcworkspace" -scheme "$APP_NAME" -archivePath "$ARCHIVE_PATH" || exit 1

        # Export the archive to an .ipa file
        EXPORT_PATH="$BUILD_OUTPUT_DIR"
        xcodebuild -exportArchive -archivePath "$ARCHIVE_PATH" -exportPath "$EXPORT_PATH" -exportOptionsPlist "$EXPORT_OPTIONS_PLIST" || exit 1

        echo "iOS app built and exported to $EXPORT_PATH/$APP_NAME.ipa"

    - name: Upload IPA as artifact
      uses: actions/upload-artifact@v4
      with:
        name: MobileTerminal-IPA
        path: ${{ github.workspace }}/builds/MobileTerminal.ipa
